\subsection{Second part: The bet}

\subsubsection{Bet Promise}
Once players decided the oracles to use, whether using the \textit{Oracle
  Selection} part or by any other mean.
They need to agree in the terms of the bet, the event and who is the winner on
  each outcome, the time available for the oracles to answer, money required by
  each player, fees of the  oracles, deposit required to the oracles, etc..
Once all the bet parameters are set, they are serialized and its hash is
  calculated, players puts all the money required to run the protocol,
  including fees and the prize into a transaction.
The selected oracles, bet hash and a method\footnote{For instance an URL to a
  website with the bet description. Oracles are responsible to check the
  description fetched with the hash provided in the transaction.} to get the
  transaction full description are appended to this transaction in plain text
  and the transaction is sent to the blockchain.
We call this transaction ``\textit{Bet Promise}'', as it is a commitment from both
  players to the bet:

\transaction
    {Bet Promise}{A previous tx, B previous tx}
    {A previous tx}{$\alpha_A$}{$\sigma_A$}
    {B previous tx}{$\alpha_B$}{$\sigma_B$}
    \stopinputs
    {0}{\footnotesize{OP\_RETURN \{Bet Channel, Oracle List, Bet hash\}}}
    {$\mathcal{P} - \fee{Bet Promise} / 2$}{(\signature{A} $\wedge$ \signature{B}) \\
                                                   $\vee$ \\
                                            (\timeout{bet} $\wedge$ \signature{A}) }
    {$\mathcal{P} - \fee{Bet Promise} / 2$}{(\signature{A} $\wedge$ \signature{B}) \\
                                                   $\vee$ \\
                                            (\timeout{bet} $\wedge$ \signature{B}) }
    {$c/n$}{(\signature{A} $\wedge$ \signature{B})}
    {\ldots }{\extra{n - 1}}
    \stopoutputs
    {tx:bet_promise}
    {Bet Promise}

The inputs for this transaction are not relevant to the protocol, they spend
  money from both player to pay for this bet.
There can be more than one input by player, and change outputs if required.
As it's unlikely the players have an unspent transaction for the exact amount
  required for the bet.
To simplificate the transaction, more inputs nor change outputs are included.

The first output does not transfer any money, but includes: the list of oracles
  asked to participate; the channel to use for retrieving the full bet and the
  hash to compare the retrieved bet against.
When an oracle sees itself in the list of oracles, it goes to the channel and
  retrieves the bet, compares it against the expected hash.
Read the description and decides to participate or not.

The second and third outputs of this transaction moves most of the money into
  a joined account, so from now on it can only be moved by both players
  together.
This represents the commitment to start the bet, as each one lock its own money
  under the other's will.
In the case one of the players disappear, after \timeout{bet} the money can
  recovered by its owner.

The outputs 3 to 3 + (n - 1) are a small portion of the money, used for the
  oracle inscriptions.
This money does not includes a timeout because it is an small amount, if players
  are willing to pay the extra fee required to add this timeout, it can be
  added.
This money is spend at the oracle inscription as commitment from the players to
  the oracles.

This transaction spends $\mathcal{P} + \frac{c}{2}$ from each player:
  $ n \cdot \frac{c}{n}$ goes to pay for oracle inscriptions; \fee{Bet Promise}
  goes to pay this transaction's fees; and
  $2 \cdot \mathcal{P} - \fee{Bet Promise} $ for paying the bet and its
  associated costs.

\subsubsection{Oracle Inscription}
Oracles invited to participate needs to retrieve the Bet description as
  instructed in the \textit{Bet Promise} transaction and decide whether to
  participate or not.
When one or more oracles do not participate, players decide how to select new
  one(s), a waiting list is recommended to be selected in the first part of the
  protocol.
When a oracle decides to participate, it builds and sends to the players its
  incription transaction, spending money from the \textit{Bet Promise}
  transaction:

\transaction
    {Oracle Inscription}{Oracle previous tx, Bet Promise}
    {Oracle previous tx}{$\alpha$}{$\sigma$}
    {Bet Promise}{3 + Oracle Index}{\signature{A} $\wedge$ \signature{B}}
    \stopinputs
    {[Registration] + c/n + [Oracle Payment] \\ - \fee{Oracle Inscription}}
        {(\signature{Oracle} $\wedge$ \signature{A} $\wedge$ \signature{B}) \\
            $\vee$ \\
         (\signature{Oracle} $\wedge$ \timeout{Bet})}
    {[Two Answers Penalty]}{((\signature{A} $\vee$ \signature{B}) $\wedge$ %
                             ($AWins_o \wedge BWins_o$)) \\
                           $\vee$ \\
                       (\signature{Oracle} $\wedge$ \timeout{two})}
    \stopoutputs
    {tx:oracle_inscription}
    {Oracle Inscription}

This transaction is the oracle's commitment with the bet and the players
  acceptance of it as oracle.
The oracle sends [Registration] + [Oracle Payment] as initial payment
  (input 0), and players c/n from the \textit{Bet Promise} (input 1).
Oracle Index goes from 0 to n - 1.

The first output takes the money under the oracle and both players control, to
  be used in the \textit{Bet} transaction.
If the Bet transaction does not go into the blockchain, the oracle can claim
  this money after \timeout{Bet}.

The second one is a penalty to be charge if the oracle misbehaves.
If the oracle reveals that player A and player B wins, this money can be taken
  by any player. Otherwise the money can be claimed back by the oracle after
  \timeout{two}.
Two Answers Penalty is the charge for voting twice, this must not be a small
  amount, as voting twice is the oracle's full responsibility.
At this output the hash of the answers is revealed ($H(AWins_o), H(BWins_o)$),
  the oracle must keeps$AWins_o$ and $BWins_o$ secret, revealing this value is
  equivalent to choose a winner.

\subsubsection{Bet}

Once the required oracles are inscribed to participate, the ``Bet'' transaction
  is built by the players.
 The first two inputs contains what is remaining from the original players
   contributions to the prize, controlled by the players' joint account.
Then, next n inputs are the outputs in the \textit{Oracle Inscription},
  containing the oracles registration.
This outputs are controlled by each oracle and both players.

Because inputs come from outputs controlled by all the participants, the
  transaction must be signed by both players and all the oracles:

\transaction
    {Bet}{Bet Promise, Oracles Inscription}
    {Bet Promise}{0}{\signature{A} $\wedge$ \signature{B}}
    {Bet Promise}{1}{\signature{A} $\wedge$ \signature{B}}
    {Oracle Inscription}{0}
        {\signature{A} $\wedge$ \signature{B} $\wedge$ \signature{O}\tikzmark{ini:a}}
        {\ldots}{\ldots}{\extra{n-1}}
    \stopinputs
    {$\mathcal{P} + n/2 \cdot $([Registration] \\
            - [Oracle Payment] \\
            - \fee{Oracle Inscription}$)$ \\
            - 1/2 (\fee{Bet Promise} + \fee{Bet})}
        {(\signature{A} $\wedge$ ($AWins_{\tilde{o}}$ $\wedge$ \ldots \tikzmark{ini:f})) \\
                          $\vee$ \\
         (\signature{B} $\wedge$ ($BWins_{\tilde{o}}$ $\wedge$ \ldots \tikzmark{ini:g})) \\
                                    $\vee$ \\
         (\signature{A} $\wedge$ \timeout{two})}
    {$\mathcal{P} + n/2 \cdot $([Registration] \\
            - [Oracle Payment] \\
            - \fee{Oracle Inscription}) \\
            - 1/2 (\fee{Bet Promise} + \fee{Bet})}
        {(\signature{A} $\wedge$ ($AWins_{\tilde{o}}$ $\wedge$ \ldots \tikzmark{ini:ff})) \\
                          $\vee$ \\
         (\signature{B} $\wedge$ ($BWins_{\tilde{o}}$ $\wedge$ \ldots \tikzmark{ini:gg})) \\
                                    $\vee$ \\
         (\signature{B} $\wedge$ \timeout{two})}
    {[Oracle Payment]}{(\signature{o} $\wedge$ ($AWins_o \vee BWins_o$) %
                       $\wedge$ \timeout{Bet}) \\
                       $\vee$ \tikzmark{ini:b} \\
                       \signature{A} $\wedge$ \signature{B} $\wedge$ %
                       \timeout{Reply}}
    {\ldots}{\extra{n-1}}
    {[Oracle Payment]}{($AWins_o$ $\wedge$ ($BWins_{\hat{o}} \wedge$ %
                        \tikzmark{ini:c} \dots) $\wedge$ \signature{B}) \\
                       $\vee$ \\
                       ($BWins_o$ $\wedge$ ($AWins_{\hat{o}}$ %
                        $\wedge$ \tikzmark{ini:d} \dots) $\wedge$ \signature{A}) \\
                       $\vee$ \\
                        \signature{o} $\wedge$ \timeout{undue}\tikzmark{ini:e}}
    {\ldots}{\extra{n-1}}
    \stopoutputs
    {tx:bet}
    {Bet}

\raisebox{31em}[0pt][0pt]{%
        \hbox{\hspace{34em} \framebox[1.1\width]{\tikzmark{end:a}$\forall o \in $ Oracles}}
}
\raisebox{27em}[0pt][0pt]{%
    \hbox{\hspace{35em}{\framebox[1\width]{%
            \parbox{80\unitlength}{\tikzmark{end:e}For at least $m\\\tilde{o} \in $ Oracles}}}}
}
\raisebox{19em}[0pt][0pt]{%
        \hbox{\hspace{36em} \framebox[1.1\width]{\tikzmark{end:b}$\forall o \in $ Oracles}}
}
\raisebox{14em}[0pt][0pt]{%
    \hbox{\hspace{35em}{\framebox[1\width]{%
            \parbox{80\unitlength}{\tikzmark{end:c}For at least $m\\\hat{o} \in $ Oracles}}}}
}
\raisebox{10em}[0pt][0pt]{%
        \hbox{\hspace{35em} \framebox[1.1\width]{\tikzmark{end:d}$\forall o \in $ Oracles}}
}
\begin{tikzpicture}[overlay, remember picture, yshift=.25\baselineskip,%
                    shorten >=.5pt, shorten <=.5pt]
    \draw [->] ([bend left,xshift=17mm]{pic cs:ini:a}) [bend left, yshift=3mm, xshift=1mm] %
                to ({pic cs:end:a});
    \draw [->] ([bend right,xshift=22mm]{pic cs:ini:b}) [bend right, yshift=-3mm, xshift=1mm] %
                to ({pic cs:end:b});
    \draw [->] ([bend right,xshift=1mm, yshift=-2mm]{pic cs:ini:c}) [bend right, yshift=0mm, xshift=-2mm] %
                to ({pic cs:end:c});
    \draw [->] ([xshift=1mm, yshift=3mm]{pic cs:ini:d}) [yshift=-4mm, xshift=-2mm] %
                to ({pic cs:end:c});
    \draw [->] ([bend left,xshift=6mm, yshift=2mm]{pic cs:ini:e}) [bend left, yshift=0mm, xshift=-2mm] %
                to ({pic cs:end:d});
    \draw [->] ([bend left,xshift=-1mm, yshift=-3mm]{pic cs:ini:f}) [bend left, yshift=4mm, xshift=2mm] %
                to ({pic cs:end:e});
    \draw [->] ([bend right,xshift=-1mm, yshift=-2mm]{pic cs:ini:g}) [bend right, yshift=1mm, xshift=-2mm] %
                to ({pic cs:end:e});
    \draw [->] ([bend right,xshift=-1mm, yshift=-3mm]{pic cs:ini:ff}) [bend right, yshift=-2mm, xshift=-2mm] %
                to ({pic cs:end:e});
    \draw [->] ([bend right,xshift=-1mm, yshift=-2mm]{pic cs:ini:gg}) [bend right, yshift=-8mm, xshift=2mm] %
                to ({pic cs:end:e});
\end{tikzpicture}

The first two outputs are the prize, it can be spend by any of the two players'
  signature plus at least $m$ votes of the oracles for that player.
When any of the players sees $m$ votes from the oracles it can get its prize.
If the threshold is not met, half of this money goes to each player and we
  say the bet is not resolved, as there is no winner.

The next n outputs are the oracles's payment for answering.
They can not be spend before \timeout{Bet}, the moment when the event happen.
It requires the vote of the oracle ($AWins_o$ or $BWins_o$) plus the oracle's
   signature.
This output binds the vote with the oracle's payment, as they are required to
  make its vote public in order to get the payment.
If the oracle does not answer after \timeout{Reply} players are allowed to
  take this money back and the oracle can not further claim its payment.

The last $n$ outputs are a withholding for the same amount of the oracle
  payment, if the oracle gives a wrong answer for the outcome, this money
  goes to the real winner.
This way we take the payment out from the oracle, as it didn't give the right
  answer.
If it behaves as expected, the oracle can spend this money some time after
  (T$_{\text{undue}}$) the bet is resolved.

There are four timeouts expressed in the transaction,
  table~\ref{table:timeouts} describe each of them in chronological order, from
  sooner to later in the protocol execution.

\begin{center}
    \begin{tabular}{|c|l|}
        \hline
          \textbf{Symbol} & \textbf{Description} \\
        \hline
        \timeout{Bet} & \makecell[l]{%
              First timeout, this is the moment the event being used to decide
              the bet \\ takes place. From this moment on oracles can vote for a
              winner and take its \\ place.} \\
        \hline
        \timeout{Reply} & \makecell[l]{%
              This timeout signals the time for the oracles to answer. After
              this timeout \\ pass, players can take the oracle's payment if the
              oracle has not replied.} \\
        \hline
        \timeout{Undue} & \makecell[l]{%
              If an oracle gave the wrong answer, players have until this
              timeout to take \\ its payment back. After this timeout the oracle
              that behaved correctly can \\ take the payment deposit back.} \\
        \hline
        \timeout{Two} & \makecell[l]{%
              The last timeout, this could be the same than \timeout{Undue}.
              Until this moment, \\  players can take the two answers penalty
              for any oracle that made public \\ the votes for both players.
              After this timeout, the oracle can take its deposit \\ back.} \\
        \hline
    \end{tabular}
    \captionof{table}{Timeouts}
    \label{table:timeouts}
\end{center}

Timeouts are enforced using Relative Lock Time (RLT) as defined by the Bitcoin
  Improvement Proposal 68 (BIP 68). Their granularity is 512 seconds, roughly
  the same time it takes to produce a new block.
As it is a 16 bits number, it's limited to be a year in the future, relative to
  the time its transaction was submitted to the blockchain.


\colorbox{red}{Goes this next paragraph here?}
If we step out a little bit, the proposed protocol uses paid oracles to get a
  binary answer about an event outside the blockchain. This is not useful only
  for betting on that outcome. The oracles are\footnote{\colorbox{red}{%
  is insensitive the word?}} insensitive to the use given to their answer, they
  get paid anyway. Further applications of the protocol can be generalized from
  our proposal.
Resolution of contractual disputes is an interesting topic, where parties agree
  to use arbitrator(s) to decide a missunderstanding.
In this case oracles takes part in the protocol more like judge than a oracle.
